stage('Blue-Green Deployment') {
    steps {
        withCredentials([
            sshUserPrivateKey(
                credentialsId: 'ec2-ssh-key',
                keyFileVariable: 'SSH_KEY'
            )
        ]) {
            sh """
                ssh -o StrictHostKeyChecking=no -i \$SSH_KEY ubuntu@${PROD_IP} '
                    set -e

                    # Determine target and old containers
                    if docker ps | grep -q app-blue; then
                        TARGET=green
                        PORT=8082
                        OLD=blue
                    else
                        TARGET=blue
                        PORT=8081
                        OLD=green
                    fi

                    echo "Deploying \$TARGET on port \$PORT"

                    # Pull latest image
                    docker pull ${DOCKER_USER}/${IMAGE_NAME}:latest

                    # Remove target container if exists
                    docker rm -f app-\$TARGET || true

                    # Run new container
                    docker run -d --name app-\$TARGET -p \$PORT:80 ${DOCKER_USER}/${IMAGE_NAME}:latest

                    # Update host Nginx to point to the container
                    sudo tee /etc/nginx/sites-enabled/default > /dev/null <<EOF
server {
    listen 80;
    location / {
        proxy_pass http://127.0.0.1:\$PORT;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
    }
}
EOF

                    # Reload Nginx
                    sudo systemctl reload nginx

                    # Remove old container
                    docker rm -f app-\$OLD || true

                    echo "Blue-Green deployment completed âœ…"
                '
            """
        }
    }
}
