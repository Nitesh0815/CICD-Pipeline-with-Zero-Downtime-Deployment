name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        run: |
          # Build specifically for linux/amd64 to ensure compatibility with EC2
          docker build -t ${{ secrets.DOCKER_USERNAME }}/my-app:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/my-app:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.HOST_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 1. Identify which container is currently 'live'
            if sudo docker ps --format '{{.Names}}' | grep -q "app-blue"; then
                TARGET_COLOR="green"
                TARGET_PORT="8082"
                OLD_COLOR="blue"
            else
                TARGET_COLOR="blue"
                TARGET_PORT="8081"
                OLD_COLOR="green"
            fi

            echo "Starting Deployment: Moving from $OLD_COLOR to $TARGET_COLOR"

            # 2. Pull the fresh image from Docker Hub
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/my-app:latest

            # 3. Remove the target container if it already exists (from a previous failed run)
            sudo docker rm -f app-$TARGET_COLOR || true

            # 4. Start the new version in parallel
            sudo docker run -d --name app-$TARGET_COLOR -p $TARGET_PORT:80 ${{ secrets.DOCKER_USERNAME }}/my-app:latest

            # 5. Health Check: Wait for the container to actually be ready
            echo "Waiting for container to start..."
            for i in {1..10}; do
              if curl -s http://127.0.0.1:$TARGET_PORT > /dev/null; then
                echo "New container is healthy!"
                break
              fi
              echo "Retrying health check ($i/10)..."
              sleep 3
            done

            # 6. The Switch: Update NGINX to point to the new port
            # We use single quotes around 'EOF' to ensure variables like $host are not expanded by the shell
            sudo bash -c 'cat > /etc/nginx/sites-available/default <<EOF
            server {
                listen 80;
                server_name _;

                location / {
                    proxy_pass http://127.0.0.1:'$TARGET_PORT';
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }
            }
            EOF'

            # 7. Apply the changes instantly
            sudo systemctl reload nginx
            echo "Traffic switched to $TARGET_COLOR"

            # 8. Cleanup: Stop the old version and remove unused images
            sudo docker rm -f app-$OLD_COLOR || true
            sudo docker image prune -af
            echo "Cleanup complete. Deployment successful!"