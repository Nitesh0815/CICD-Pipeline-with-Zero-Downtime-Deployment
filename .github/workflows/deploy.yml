name: CI/CD Blue-Green Deployment

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        run: |
          # We use the 'latest' tag for simplicity, but in production, you'd use the Commit SHA
          docker build -t ${{ secrets.DOCKER_USERNAME }}/my-app:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/my-app:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Blue-Green Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.HOST_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 1. Check which container is currently running
            if [ "$(sudo docker ps -q -f name=app-blue)" ]; then
                TARGET_COLOR="green"
                TARGET_PORT=8082
                OLD_COLOR="blue"
            else
                TARGET_COLOR="blue"
                TARGET_PORT=8081
                OLD_COLOR="green"
            fi

            echo "Deploying to $TARGET_COLOR on port $TARGET_PORT..."

            # 2. Pull the latest image
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/my-app:latest

            # 3. Start the NEW container (Green) while the OLD one (Blue) is still running
            sudo docker run -d --name app-$TARGET_COLOR -p $TARGET_PORT:80 ${{ secrets.DOCKER_USERNAME }}/my-app:latest

            # 4. Wait for the new container to initialize
            sleep 10

            # 5. Update Nginx configuration to point to the new port
            # This replaces the default config with a proxy to the new container
            sudo bash -c "cat > /etc/nginx/sites-available/default <<EOF
            server {
                listen 80;
                location / {
                    proxy_pass http://127.0.0.1:$TARGET_PORT;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                }
            }
            EOF"

            # 6. Reload Nginx (This is the Zero-Downtime moment)
            sudo systemctl reload nginx
            echo "Traffic switched to $TARGET_COLOR"

            # 7. Shut down the OLD container now that traffic has moved
            sudo docker stop app-$OLD_COLOR || true
            sudo docker rm app-$OLD_COLOR || true
            
            # 8. Prune old images to save disk space
            sudo docker image prune -f
